;(function($,_,undefined){"use strict";ips.createModule('ips.ui.truncateSt',function(){var defaults={type:'remove',size:100,expandText:ips.getString('show_more'),watch:true};var respond=function(elem,options){if(options.type=='remove'){_removeTruncate(elem,_.defaults(options,defaults));}else{_hideTruncate(elem,_.defaults(options,defaults));}},_removeTruncate=function(elem,options){if(elem.children().first().prop('tagName')=='P'){elem.html(elem.children().first().html());}
var size=_getSizeValue(options.size,elem);var clampTo=(size.lines)?size.lines:size.pixels+'px';elem.dotdotdot({height:size.pixels,watch:options.watch});elem.trigger('contentTruncated',{type:'remove'});},_hideTruncate=function(elem,options){var size=_getSizeValue(options.size,elem);var originalSize=elem.outerHeight();var originalPos=$(elem).css('position');if(originalSize<=size.pixels){Debug.log('Smaller than the specified size, finishing...');return;}
if(originalPos=='static'){$(elem).css('position','relative');}
$(elem).css({height:size.pixels+'px'}).addClass('ipsTruncate');var showMore=ips.templates.render('core.truncate.expand',{text:options.expandText});$(elem).after(showMore);var expander=elem.next("[data-action='expandTruncate']");elem.trigger('contentTruncated',{type:'hide'});var _truncated=true;expander.on('click',function(e){if(_truncated){elem.css({height:'auto'});var newOriginalSize=elem.outerHeight();elem.css({height:size.pixels+'px'});var show_less='<span>'+ips.getString('topicfeed_show_less')+' &nbsp;<i class="fa fa-caret-up"></i></span>';var expander=elem.next("[data-action='expandTruncate']");expander.html($(show_less).html());if(newOriginalSize>size.pixels){$(elem).animate({height:newOriginalSize+'px'},function(){$(this).css({'position':originalPos,'height':'auto'});$(elem).trigger('truncateExpanded');});}
_truncated=false;}
else{$(elem).animate({height:size.pixels+'px',display:'none'},450,function(){var expander=elem.next("[data-action='expandTruncate']");expander.html($(showMore).html()).fadeIn(450);elem.trigger('contentTruncated',{type:'hide'});_truncated=true;});}});},_getSizeValue=function(value,elem){try{if($(value).length){return{pixels:$(value).first().outerHeight()};}}catch(err){}
if(String(value).indexOf('lines')!==-1){var lines=parseInt(value.replace('lines',''));var number=lines*_getLineHeight(elem);return{lines:lines,pixels:number};}else{return{pixels:parseInt(value)};}},_getLineHeight=function(elem){var lH=$(elem).css('line-height');return parseInt(lH);};ips.ui.registerWidget('truncateSt',ips.ui.truncateSt,['type','size','expandText','watch']);return{respond:respond};});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('plugins.bim.statusReplies',{_statusID:null,_statusMember:null,initialize:function(){this.on('submit','[data-role="replyComment"]',this.submitNewReply);this.on('quoteComment.comment',this.quoteComment);this.on('menuItemSelected','.statusTools [data-ipsMenu]',this._menuItemSelected);this.on('reloadFeed',this.reloadFeed);this.on('paginationClicked paginationJump',this.paginationClicked);this.on('submit','[data-role="pageJump"]',this.paginationSubmit);this.on('submit','[data-role="statusComments"] form',this.submitEdit);this.on('click','[data-action="loadPreviousComments"]',this.loadPrevious);this.on('click','.showCommentForm',this.toggleCommentForm);this._statusID=this.scope.attr('data-statusID');this._statusMember=this.scope.attr('data-statusMember');},loadPrevious:function(e){e.preventDefault();var self=this;var results=this.scope.find('[data-role="statusComments"]');var url=$(e.currentTarget).attr('href')+"&inPopup=1";this._ajax=ips.getAjax()(url,{showLoading:true,}).done(function(response){results.find('.cStatusUpdates_pagination').remove();results.prepend(response);$(document).trigger('contentChange',[results]);});},submitNewReply:function(e){var form=this.scope.find('[data-role="replyComment"] form');if(form.attr('data-noAjax')){return;}
e.preventDefault();e.stopPropagation();var page=this.scope.attr('data-page');if(!page){page=1;}
var self=this;form.find('button[type="submit"]').prop('disabled',true).text(ips.getString('updatingStatus'));ips.getAjax()(form.attr('action').replace('&do=bimStatusReplies',''),{data:form.serialize()+'&submitting=true&currentPage='+page+'&inPopup=1',type:'post',bypassRedirect:true}).done(function(response){form.find('.ipsComposeArea').addClass('ipsComposeArea_minimized');form.find('.ipsComposeArea_dummy').show().addClass('showCommentForm');form.find('[data-role="mainEditorArea"]').hide();form.find('[data-ipsEditor-toolList]').hide();ips.ui.editor.getObj(self.scope.find('[data-role="replyComment"] [data-ipsEditor]')).reset();self.scope.find('[data-role="statusComments"]').append(response.content);$(document).trigger('contentChange',[self.scope]);}).always(function(){form.find('button[type="submit"]').prop('disabled',false).text(ips.getString('submit_reply'));});return false;},toggleCommentForm:function(e){var form=$(e.currentTarget).closest('form');if(form.find('.ipsComposeArea_dummy').is(":hidden")){form.find('.ipsComposeArea').addClass('ipsComposeArea_minimized');form.find('.ipsComposeArea_dummy').show().addClass('showCommentForm');form.find('[data-role="mainEditorArea"]').hide();form.find('[data-ipsEditor-toolList]').hide();}
else{form.find('.ipsComposeArea').removeClass('ipsComposeArea_minimized');form.find('.ipsComposeArea_dummy').hide();form.find('[data-role="mainEditorArea"]').show();form.find('[data-ipsEditor-toolList]').show();}
return false;},paginationClicked:function(e,data){var self=this;var results=this.scope.find('[data-role="statusComments"]');var url=data.href;data.originalEvent.preventDefault();if(url=='#'){url=data.paginationElem.find('[data-role="pageJump"]').attr('action')+'&page='+data.pageNo;}
this._ajax=ips.getAjax()(url,{showLoading:true,}).done(function(response){results.html(response);self.scope.attr('data-page',data.pageNo);$(document).trigger('contentChange',[results]);});return false;},paginationSubmit:function(e){e.preventDefault();return false;},quoteComment:function(e,data){if(!this.scope.find('[data-ipsEditor]:visible').length){this.scope.find('[data-role="statusComments"] form').focus();}
var editor=ips.ui.editor.getObj(this.scope.find('[data-ipsEditor]').first());if(editor){editor.insertQuotes([data]);}},_menuItemSelected:function(e,data){e=data?data.originalEvent:e;e.preventDefault();switch($(e.target).attr('data-action')){case'edit':this._edit(e);break;case'delete':this._delete(e);break;case'hide':case'unhide':this._reloadReplies(e);break;default:return;}},_reloadReplies:function(e){e.preventDefault();var feed=this.scope.find('[data-role="statusComments"]');ips.getAjax()($(e.target).attr('href')).done(function(response){feed.trigger('reloadFeed');});return false;},reloadFeed:function(e){var results=this.scope.find('[data-role="statusComments"]');var page=this.scope.attr('data-page');if(typeof page=='undefined'){page=1;}
var self=this;ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=core&module=system&controller=plugins&do=bimStatusReplies',{showLoading:true,data:{status:self._statusID,member:self._statusMember,page:page}}).done(function(response){results.html(response).hide().fadeIn();$(document).trigger('contentChange',[results]);}).always(function(){self.scope.trigger('reloadedFeed');});},_delete:function(e){var self=this;ips.ui.alert.show({type:'confirm',message:ips.getString('bimStatus_deleteReplyConfirm'),icon:'warn',callbacks:{ok:function(){self._reloadReplies(e);}}});},_edit:function(e){e.preventDefault();var url=$(e.target).attr('href');var id=$(e.target).attr('data-replyID');var contentArea=$('.reply_'+id);$(contentArea).animate({opacity:0.333},300);var self=this;ips.getAjax()($(e.target).attr('href'),{showLoading:true,data:{}}).done(function(response){contentArea.html(response).animate({opacity:1},300);$(document).trigger('contentChange',[contentArea]);contentArea.find('button[type="submit"]').attr('type','do_edit');contentArea.find('form').attr('data-replyID',id);});return false;},submitEdit:function(e){e.stopPropagation();e.preventDefault();var form=$(e.target);var submit=$(form).find('button[type="do_edit"]');var id=form.attr('data-replyID');var contentArea=$('.reply_'+id);var currentText=submit.text();submit.prop('disabled',true).text(ips.getString('saving'));ips.getAjax()($(form).attr('action')+"&inPopup=1",{showLoading:true,data:form.serialize(),bypassRedirect:true,method:"POST"}).done(function(response){contentArea.html(response).hide().fadeIn();$(document).trigger('contentChange',[contentArea]);}).always(function(){submit.prop('disabled',false).text(currentText);});},});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('plugins.bim.statusUpdatesWidget',{widgetKey:null,menu:null,initialize:function(){this.on('focus','[data-role="statusFormArea"] .ipsComposeArea_dummy',this.focusNewStatus);this.on('submit','[data-role="statusFormArea"] form',this.submitNewStatus);this.on('submit','[data-role="statusFeed"] form',this.submitEdit);this.on('paginationClicked paginationJump',this.paginationClicked);this.on('menuItemSelected','.statusTools [data-ipsMenu]',this._menuItemSelected);this.on('reloadFeed',this.reloadFeed);this.on('menuOpened','[data-role="feedMenu"]',this.feedMenu);this.widgetKey=this.scope.attr('data-widgetKey');},feedMenu:function(e,data){var self=this;if(!self.menu){self.menu=data['menu'];self.menu.find('form').on('submit',{widgetKey:self.widgetKey},self.submitSetting);}},submitSetting:function(e){e.preventDefault();var self=$('[data-controller="plugins.bim.statusUpdatesWidget"][data-widgetKey="'+e.data.widgetKey+'"]');var form=$(e.target).animate({opacity:0.5},300);ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=core&module=system&controller=plugins&do=bimStatusFeed',{data:form.serialize()+'&checkConf=1&widgetKey='+e.data.widgetKey,bypassRedirect:true}).always(function(){$(self).trigger('reloadFeed');$(self).one('reloadedFeed',function(){form.animate({opacity:1},300);});});return false;},focusNewStatus:function(e){e.preventDefault();var self=this;$(e.currentTarget).text(ips.getString('loading')+"...");ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=core&module=system&controller=plugins&do=bimStatusCreate&widgetKey='+this.widgetKey).done(function(response){self.scope.find('[data-role="statusEditor"]').show();self.scope.find('[data-role="statusEditor"]').html(response);self.scope.find('[data-role="statusDummy"]').hide().find('.ipsComposeArea_dummy').text(ips.getString('whatsOnYourMind'));$(document).trigger('contentChange',[self.scope.find('[data-role="statusEditor"]')]);});return false;},submitNewStatus:function(e){e.preventDefault();var self=this;var form=$(e.currentTarget);form.find('button[type="submit"]').prop('disabled',true).text(ips.getString('updatingStatus'));ips.getAjax()(form.attr('action'),{data:form.serialize(),type:'post',bypassRedirect:true}).done(function(response){var newStatus=$(response.content);self.scope.find('[data-role="statusDummy"]').show();self.scope.find('[data-role="statusEditor"]').hide();self.scope.find('[data-role="statusFeedEmpty"]').hide();self.scope.find('[data-role="statusFeed"]').prepend(newStatus).find('[data-statusID="'+response.id+'"]').hide().slideDown();$(document).trigger('contentChange',[self.scope.find('[data-role="statusFeed"]')]);}).always(function(){form.find('button[type="submit"]').prop('disabled',false).text(ips.getString('submitStatus'));});},paginationClicked:function(e,data){if(ips.getSetting('bimStatus_disableAjax')){return false;}
var self=this;var results=this.scope.find('[data-role="statusFeed"]');var url=data.href;data.originalEvent.preventDefault();if(url=='#'){url=data.paginationElem.find('[data-role="pageJump"]').attr('action')+'&bimsuPage='+data.pageNo;}
this._ajax=ips.getAjax()(url,{showLoading:true,}).done(function(response){$('html, body').animate({scrollTop:self.scope.offset().top},600);results.html(response);$(document).trigger('contentChange',[results]);});},_menuItemSelected:function(e,data){e=data?data.originalEvent:e;e.preventDefault();switch($(e.target).attr('data-action')){case'edit':this._edit(e);break;case'delete':this._delete(e);break;case'hide':case'unhide':case'lock':case'unlock':this._reloadStatuses(e);break;default:return;}},reloadFeed:function(e){var results=this.scope.find('[data-role="statusFeed"]');var page=this.scope.find('[data-role="statusFeed"] .ipsPagination_active a').attr('data-page');if(typeof page=='undefined'){page=1;}
var self=this;ips.getAjax()(ips.getSetting('baseURL')+'index.php?app=core&module=system&controller=plugins&do=bimStatusFeed',{showLoading:true,data:{widgetKey:self.widgetKey,bimsuPage:page}}).done(function(response){results.html(response);$(document).trigger('contentChange',[results]);}).always(function(){self.scope.trigger('reloadedFeed');});},_edit:function(e){e.preventDefault();var url=$(e.target).attr('href');var id=$(e.target).attr('data-statusID');var contentArea=$('.bimStatus_'+id).find('[data-role="statusContent"]');$(contentArea).animate({opacity:0.333},300);var self=this;ips.getAjax()($(e.target).attr('href'),{showLoading:true,data:{widgetKey:self.widgetKey}}).done(function(response){contentArea.html(response).animate({opacity:1},300);$(document).trigger('contentChange',[contentArea]);contentArea.closest('.ipsDataItem_main').find('.statusTools').hide();contentArea.find('button[type="submit"]').attr('type','do_edit');contentArea.find('form').attr('data-statusID',id);});return false;},submitEdit:function(e){e.stopPropagation();e.preventDefault();var form=$(e.target);var submit=$(form).find('button[type="do_edit"]');var id=form.attr('data-statusID');var contentArea=$('.bimStatus_'+id).find('[data-role="statusContent"]');var currentText=submit.text();submit.prop('disabled',true).text(ips.getString('saving'));var self=this;ips.getAjax()($(form).attr('action'),{showLoading:true,data:form.serialize(),bypassRedirect:true,method:"POST"}).done(function(response){contentArea.html($(response).find('[data-role="statusContent"]').first().html()).hide().fadeIn();$(document).trigger('contentChange',[self.scope.find('.bimStatusUpdatesWidget')]);contentArea.closest('.ipsDataItem_main').find('.statusTools').fadeIn();}).always(function(){submit.prop('disabled',false).text(currentText);});},_delete:function(e){e.preventDefault();var self=this;ips.ui.alert.show({type:'confirm',message:ips.getString('bimStatus_deleteConfirm'),icon:'warn',callbacks:{ok:function(){self._reloadStatuses(e);}}});return false;},_reloadStatuses:function(e){e.preventDefault();var feed=this.scope.find('.bimStatusUpdatesWidget');ips.getAjax()($(e.target).attr('href')).done(function(response){feed.trigger('reloadFeed');});return false;},});}(jQuery,_));;